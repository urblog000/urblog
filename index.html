<!doctype html>
<html lang="ro">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="description" content="URBlog - Scrie și citește postări scurte.">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://urblog.example.com/">
    <title>UrBlog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --header-gradient: linear-gradient(to right, #c2cfd8, #98d6f0, #428bca);
            --card-bg: #d1d1d1;
            --white: #ffffff;
            --text: #000000;
            --radius: 14px;
            --muted: #555555;
            --accent: #428bca;
            --error: #dc3545;
            --success: #28a745;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: #f0f2f5; color: var(--text); line-height: 1.5; }
        header { 
            background: var(--header-gradient); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 12px 24px; color: var(--white);
        }
        header .left, header .center, header .right { display: flex; align-items: center; }
        header .left { flex: 0 0 auto; font-size: 24px; font-weight: bold; cursor: pointer; }
        header .center { flex: 1; justify-content: center; font-size: 24px; font-weight: bold; }
        header .right { gap: 10px; }
        header .right .profile-pic {
            width: 40px; height: 40px; border-radius: 50%; overflow: hidden; 
            background: var(--white); display: grid; place-items: center; 
            color: var(--muted); font-size: 12px; cursor: pointer;
        }

        main { padding: 20px; }
        .post-card { 
            background: var(--card-bg); border-radius: var(--radius); 
            padding: 20px; max-width: 600px; margin: 20px auto;
        }
        .post-header { display: flex; align-items: center; gap: 14px; margin-bottom: 14px; }
        .post-header .profile-pic {
            width: 36px; height: 36px; border-radius: 50%; overflow: hidden; 
            background: var(--white); display: grid; place-items: center; 
            color: var(--muted); font-size: 12px;
        }
        .post-header .username { font-size: 20px; font-weight: bold; color: var(--text); }
        .post-header .time { font-size: 13px; color: var(--muted); }
        
        .post-content { 
            background: var(--white); padding: 16px; border-radius: var(--radius); 
            font-size: 16px; color: var(--text); margin-bottom: 10px; 
            white-space: pre-wrap; 
        }

        /* Comentarii */
        .comment-section { margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px; }
        .comment-item { 
            margin-bottom: 8px; padding: 8px; border-left: 3px solid var(--accent); 
            background: #f8f8f8; border-radius: 4px; font-size: 14px;
        }
        .comment-author { font-weight: bold; color: var(--accent); margin-right: 5px; }
        .comment-form { display: flex; gap: 5px; margin-top: 10px; }

        /* Composer & Auth */
        .composer, .auth-form {
            margin: 30px auto; max-width: 600px; background: var(--white); 
            border-radius: var(--radius); padding: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .composer h3, .auth-form h3 { margin-bottom: 12px; color: var(--text); }
        .composer label, .auth-form label { display: block; margin-top: 12px; font-weight: 600; color: var(--text); }
        .composer input, .composer textarea, .auth-form input { 
            width: 100%; padding: 10px; margin-top: 6px; 
            border: 1px solid #ccc; border-radius: var(--radius); font-size: 14px; 
        }
        .composer textarea { min-height: 120px; resize: vertical; }
        .composer .row, .auth-form .row { display: flex; gap: 10px; margin-top: 16px; }
        .btn { padding: 10px 14px; border: none; border-radius: var(--radius); cursor: pointer; font-size: 14px; }
        .btn-primary { background: var(--accent); color: var(--white); }
        .btn-primary:hover { background: #357bd1; }
        .btn-ghost { background: transparent; border: 1px solid #aaa; color: var(--text); }
        .btn-ghost:hover { background: #ddd; transition: 0.2s ease-in-out; }
        .message.error { color: var(--error); }
        .message.success { color: var(--success); }

        footer { margin-top: 40px; text-align: center; padding: 20px; color: var(--muted); }
    </style>
</head>
<body>
    <header>
        <div class="left" id="addPostBtn" style="visibility: hidden;">＋</div>
        <div class="center">URBLOG</div>
        <div class="right">
            <div class="profile-pic" id="headerProfilePic">👤</div>
            <button id="logoutBtn" class="btn btn-ghost" style="display:none;">Ieșire</button>
        </div>
    </header>

    <main>
        <section class="auth-form" id="authSection">
            <h3>Autentificare / Înregistrare</h3>
            <div id="loginForm">
                <label for="authEmail">Email</label>
                <input type="email" id="authEmail" placeholder="email@exemplu.ro">
                <label for="authPassword">Parolă</label>
                <input type="password" id="authPassword" placeholder="******">
                <p id="authMessage" class="message error" style="margin-top: 10px;"></p>
                <div class="row">
                    <button type="button" id="loginBtn" class="btn btn-primary">Autentificare</button>
                    <button type="button" id="signupBtn" class="btn btn-ghost">Înregistrare</button>
                </div>
            </div>
        </section>
        
        <section class="composer" id="composer" style="display:none;">
            <h3>Adaugă postare</h3>
            <form id="postForm">
                <label for="title">Titlu</label>
                <input type="text" id="postTitle" placeholder="Titlul postării">
                <label for="content">Conținut</label>
                <textarea id="postContent" placeholder="Scrie postarea..."></textarea>
                <p id="postMessage" class="message success" style="margin-top: 10px;"></p>
                <div class="row">
                    <button type="submit" class="btn btn-primary">Publică</button>
                    <button type="button" id="clearBtn" class="btn btn-ghost">Șterge</button>
                </div>
            </form>
        </section>

        <div id="postsContainer">
            <div class='post-card'>Se încarcă postările...</div>
        </div>
    </main>

    <footer>
        &copy; <span id="year"></span> URBLOG
    </footer>

    <script type="module">
        // PASUL 1: Importă SDK-urile necesare din Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            onValue, 
            serverTimestamp,
            get,
            query,
            orderByChild,
            remove
        } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        // *************************************************************************************************
        // PASUL 2: CONFIGURARE - VERIFICĂ ȘI ÎNLOCUIEȘTE CU DATELE TALE REALE
        // Am presupus că folosești Realtime Database (RTDB) pentru postări.
        // *************************************************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyCMY5tUsx-DmAtvpG4UQlbyY99fJrgmgSM",
            authDomain: "site-99197.firebaseapp.com",
            // Adaugă databaseURL pentru Realtime Database!
            databaseURL: "https://site-99197-default-rtdb.firebaseio.com", 
            projectId: "site-99197",
            storageBucket: "site-99197.firebasestorage.app",
            messagingSenderId: "246047528041",
            appId: "1:246047528041:web:bb46208af9b32a1b79bef8",
            measurementId: "G-6942F03VFS"
        };
        
        // Inițializare Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Referințe DOM
        const postsContainer = document.getElementById('postsContainer');
        const postForm = document.getElementById('postForm');
        const postTitleInput = document.getElementById('postTitle');
        const postContentInput = document.getElementById('postContent');
        const authSection = document.getElementById('authSection');
        const composerSection = document.getElementById('composer');
        const logoutBtn = document.getElementById('logoutBtn');
        const headerProfilePic = document.getElementById('headerProfilePic');
        const postMessage = document.getElementById('postMessage');
        const authMessage = document.getElementById('authMessage');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const addPostBtn = document.getElementById('addPostBtn');
        
        document.getElementById('year').textContent = new Date().getFullYear();

        let currentUser = null; // Obiectul utilizator curent

        // *************************************************************************************************
        // 1. GESTIONAREA AUTENTIFICĂRII
        // *************************************************************************************************
        
        // Ascultă schimbările în starea de autentificare (login/logout)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authSection.style.display = 'none';
                composerSection.style.display = 'block';
                logoutBtn.style.display = 'block';
                addPostBtn.style.visibility = 'visible';
                headerProfilePic.textContent = user.email.substring(0, 2).toUpperCase();
                loadPosts(); // Încarcă postările doar după autentificare
            } else {
                currentUser = null;
                authSection.style.display = 'block';
                composerSection.style.display = 'none';
                logoutBtn.style.display = 'none';
                addPostBtn.style.visibility = 'hidden';
                headerProfilePic.textContent = '👤';
                postsContainer.innerHTML = "<div class='post-card'>Te rugăm să te autentifici pentru a vedea postările.</div>";
            }
        });

        // Funcții Login/Signup/Logout
        document.getElementById('signupBtn').addEventListener('click', async () => {
            try {
                await createUserWithEmailAndPassword(auth, authEmail.value, authPassword.value);
                authMessage.textContent = 'Înregistrare reușită. Ești logat!';
                authMessage.className = 'message success';
            } catch (error) {
                authMessage.textContent = `Eroare: ${error.message}`;
                authMessage.className = 'message error';
            }
        });

        document.getElementById('loginBtn').addEventListener('click', async () => {
            try {
                await signInWithEmailAndPassword(auth, authEmail.value, authPassword.value);
                authMessage.textContent = 'Autentificare reușită!';
                authMessage.className = 'message success';
            } catch (error) {
                authMessage.textContent = `Eroare: ${error.message}`;
                authMessage.className = 'message error';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
        });

        // *************************************************************************************************
        // 2. GESTIONAREA POSTĂRILOR (Realtime Database)
        // *************************************************************************************************

        // Funcție helper pentru a evita XSS
        function escapeHtml(str) {
            if (!str && str !== "") return "";
            return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/\'/g, "&#39;");
        }

        // Adaugă Postare
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                postMessage.textContent = 'Trebuie să fii logat pentru a posta!';
                postMessage.className = 'message error';
                return;
            }

            const title = postTitleInput.value.trim();
            const content = postContentInput.value.trim();

            if (title.length < 3 || content.length < 10) {
                postMessage.textContent = "Titlul min. 3, Conținut min. 10 caractere.";
                postMessage.className = 'message error';
                return;
            }

            const submitBtn = postForm.querySelector('button[type=submit]');
            submitBtn.disabled = true;
            submitBtn.textContent = "Se publică...";

            const newPost = {
                title: title,
                content: content,
                authorId: currentUser.uid,
                authorEmail: currentUser.email,
                date: serverTimestamp()
            };

            try {
                await push(ref(db, 'posts'), newPost);
                postForm.reset();
                postMessage.textContent = 'Postare publicată cu succes!';
                postMessage.className = 'message success';
                setTimeout(() => postMessage.textContent = '', 3000);
            } catch (error) {
                postMessage.textContent = `Eroare la publicare: ${error.message}`;
                postMessage.className = 'message error';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Publică";
            }
        });

        // Încarcă și Randează Postările în Timp Real
        function loadPosts() {
            const postsRef = ref(db, 'posts');
            const sortedQuery = query(postsRef, orderByChild('date'));

            onValue(sortedQuery, (snapshot) => {
                postsContainer.innerHTML = '';
                if (!snapshot.exists()) {
                    postsContainer.innerHTML = "<div class='post-card'>Nu există postări încă. Fii primul!</div>";
                    return;
                }

                const postsArray = [];
                snapshot.forEach(childSnapshot => {
                    // Adaugă postarea în fața listei (sortare descrescătoare vizuală)
                    postsArray.unshift({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });

                postsArray.forEach(post => {
                    const postElement = createPostElement(post);
                    postsContainer.appendChild(postElement);
                    loadComments(post.id, postElement);
                });
            });
        }

        // Crearea elementului DOM pentru o postare
        function createPostElement(p) {
            const timestamp = p.date;
            const dateStr = timestamp ? new Date(timestamp).toLocaleString('ro-RO') : 'Data necunoscută';
            const initials = p.authorEmail ? p.authorEmail.substring(0, 2).toUpperCase() : '??';

            const div = document.createElement('div');
            div.className = 'post-card';
            div.innerHTML = `
                <div class="post-header">
                    <div class="profile-pic">${initials}</div>
                    <div>
                        <div class="username">${escapeHtml(p.title)}</div>
                        <div class="time">${escapeHtml(p.authorEmail)} · ${dateStr}</div>
                    </div>
                </div>
                <div class="post-content">${escapeHtml(p.content)}</div>
                
                <div class="post-actions" style="text-align: right;">
                    ${currentUser && currentUser.uid === p.authorId ? 
                        `<button class="btn btn-ghost delete-post-btn" data-id="${p.id}">🗑️ Șterge</button>` : ''
                    }
                </div>

                <div class="comment-section">
                    <h4>Comentarii:</h4>
                    <div id="comments-container-${p.id}"></div>
                    
                    ${currentUser ? `
                        <div class="comment-form">
                            <input type="text" id="comment-input-${p.id}" placeholder="Adaugă un comentariu..." style="width: 100%; border-radius: ${getComputedStyle(document.documentElement).getPropertyValue('--radius')};">
                            <button class="btn btn-primary submit-comment-btn" data-post-id="${p.id}">Trimite</button>
                        </div>
                    ` : '<p style="font-size: 14px; margin-top: 10px;">Autentifică-te pentru a comenta.</p>'}
                </div>
            `;

            // Adaugă listener pentru ștergere
            if (currentUser && currentUser.uid === p.authorId) {
                div.querySelector(".delete-post-btn").addEventListener("click", async (e) => {
                    if (confirm("Ești sigur că vrei să ștergi această postare și toate comentariile sale?")) {
                        const postId = e.target.getAttribute('data-id');
                        await remove(ref(db, `posts/${postId}`));
                    }
                });
            }

            // Adaugă listener pentru comentariu
            if (currentUser) {
                div.querySelector(`.submit-comment-btn`).addEventListener('click', () => {
                    const postId = p.id;
                    const commentInput = div.querySelector(`#comment-input-${postId}`);
                    submitComment(postId, commentInput.value.trim());
                    commentInput.value = '';
                });
            }

            return div;
        }

        // *************************************************************************************************
        // 3. GESTIONAREA COMENTARIILOR
        // *************************************************************************************************
        
        // Adaugă Comentariu
        function submitComment(postId, commentText) {
            if (!currentUser || !commentText) return;

            const newComment = {
                text: commentText,
                authorEmail: currentUser.email,
                date: serverTimestamp()
            };

            push(ref(db, `posts/${postId}/comments`), newComment)
                .catch(error => console.error('Eroare la salvarea comentariului:', error));
        }

        // Încarcă și Randează Comentariile în Timp Real
        function loadComments(postId, postElement) {
            const commentsRef = ref(db, `posts/${postId}/comments`);
            const commentsContainer = postElement.querySelector(`#comments-container-${postId}`);
            const sortedQuery = query(commentsRef, orderByChild('date'));

            onValue(sortedQuery, (snapshot) => {
                commentsContainer.innerHTML = '';
                if (!snapshot.exists()) {
                    commentsContainer.innerHTML = '<p class="comments">Fii primul care comentează!</p>';
                    return;
                }
                
                snapshot.forEach(childSnapshot => {
                    const c = childSnapshot.val();
                    const date = c.date ? new Date(c.date).toLocaleTimeString('ro-RO', {hour: '2-digit', minute:'2-digit'}) : '';
                    
                    const p = document.createElement('div');
                    p.className = 'comment-item';
                    p.innerHTML = `<span class="comment-author">${escapeHtml(c.authorEmail)} (${date}):</span> ${escapeHtml(c.text)}`;
                    commentsContainer.appendChild(p);
                });
            });
        }

        // Diverse
        document.getElementById('clearBtn').addEventListener('click', () => {
            postForm.reset();
        });

        document.getElementById('addPostBtn').addEventListener('click', () => {
            composerSection.scrollIntoView({ behavior: 'smooth' });
            postTitleInput.focus();
        });

        // Inițializează vizualizarea postărilor (va fi gestionată de onAuthStateChanged)
        if (!currentUser) loadPosts(); // Afișează "loghează-te" mesaj

    </script>
</body>
</html>
