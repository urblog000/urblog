<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="description" content="URBlog - Scrie și citește postări scurte.">
<title>URBlog</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --header-gradient: linear-gradient(to right, #c2cfd8, #98d6f0, #428bca);
    --card-bg: #d1d1d1;
    --white: #ffffff;
    --text: #000000;
    --radius: 14px;
    --muted: #555555;
    --accent: #428bca;
    --error: #dc3545;
    --success: #28a745;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: #f0f2f5; color: var(--text); line-height: 1.5; }
header { 
    background: var(--header-gradient); 
    display: flex; align-items: center; justify-content: space-between; 
    padding: 12px 24px; color: var(--white);
}
header .left, header .center, header .right { display: flex; align-items: center; }
header .left { flex: 0 0 auto; font-size: 24px; font-weight: bold; cursor: pointer; visibility:hidden; }
header .center { flex: 1; justify-content: center; font-size: 24px; font-weight: bold; }
header .right { gap: 10px; }
header .right .profile-pic {
    width: 40px; height: 40px; border-radius: 50%; overflow: hidden; 
    background: var(--white); display: grid; place-items: center; 
    color: var(--muted); font-size: 12px; cursor: pointer;
}
main { padding: 20px; }
.post-card { 
    background: var(--card-bg); border-radius: var(--radius); 
    padding: 20px; max-width: 600px; margin: 20px auto;
}
.post-header { display: flex; align-items: center; gap: 14px; margin-bottom: 14px; }
.post-header .profile-pic {
    width: 36px; height: 36px; border-radius: 50%; overflow: hidden; 
    background: var(--white); display: grid; place-items: center; 
    color: var(--muted); font-size: 12px;
}
.post-header .username { font-size: 20px; font-weight: bold; color: var(--text); }
.post-header .time { font-size: 13px; color: var(--muted); }
.post-content { 
    background: var(--white); padding: 16px; border-radius: var(--radius); 
    font-size: 16px; color: var(--text); margin-bottom: 10px; 
    white-space: pre-wrap; 
}
.comment-section { margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px; }
.comment-item { 
    margin-bottom: 8px; padding: 8px; border-left: 3px solid var(--accent); 
    background: #f8f8f8; border-radius: 4px; font-size: 14px;
}
.comment-author { font-weight: bold; color: var(--accent); margin-right: 5px; }
.comment-time { font-size: 12px; color: var(--muted); margin-left: 5px; }
.comment-form { display: flex; gap: 5px; margin-top: 10px; }
.comment-form input { border-radius: var(--radius); border: 1px solid #ccc; padding: 10px; flex-grow: 1; }
.composer, .auth-form {
    margin: 30px auto; max-width: 600px; background: var(--white); 
    border-radius: var(--radius); padding: 20px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.composer h3, .auth-form h3 { margin-bottom: 12px; color: var(--text); }
.composer label, .auth-form label { display: block; margin-top: 12px; font-weight: 600; color: var(--text); }
.composer input, .composer textarea, .auth-form input { 
    width: 100%; padding: 10px; margin-top: 6px; 
    border: 1px solid #ccc; border-radius: var(--radius); font-size: 14px; 
}
.composer textarea { min-height: 120px; resize: vertical; }
.composer .row, .auth-form .row { display: flex; gap: 10px; margin-top: 16px; }
.btn { padding: 10px 14px; border: none; border-radius: var(--radius); cursor: pointer; font-size: 14px; }
.btn-primary { background: var(--accent); color: var(--white); }
.btn-primary:hover { background: #357bd1; }
.btn-ghost { background: transparent; border: 1px solid #aaa; color: var(--text); }
.btn-ghost:hover { background: #ddd; transition: 0.2s ease-in-out; }
.message.error { color: var(--error); }
.message.success { color: var(--success); }
.submit-comment-btn { padding: 10px 14px; font-size: 14px; white-space: nowrap; }
footer { margin-top: 40px; text-align: center; padding: 20px; color: var(--muted); }
</style>
</head>
<body>
<header>
    <div class="left" id="addPostBtn">＋</div>
    <div class="center">URBLOG</div>
    <div class="right">
        <div class="profile-pic" id="headerProfilePic">👤</div>
        <button id="logoutBtn" class="btn btn-ghost" style="display:none;">Ieșire</button>
    </div>
</header>
<main>
<section class="auth-form" id="authSection">
    <h3>Autentificare / Înregistrare</h3>
    <div id="loginForm">
        <label for="authEmail">Email</label>
        <input type="email" id="authEmail" placeholder="email@exemplu.ro">
        <label for="authPassword">Parolă</label>
        <input type="password" id="authPassword" placeholder="******">
        <p id="authMessage" class="message error" style="margin-top: 10px;"></p>
        <div class="row">
            <button type="button" id="loginBtn" class="btn btn-primary">Autentificare</button>
            <button type="button" id="signupBtn" class="btn btn-ghost">Înregistrare</button>
        </div>
    </div>
</section>

<section class="composer" id="composer" style="display:none;">
    <h3>Adaugă postare</h3>
    <form id="postForm">
        <label for="title">Titlu</label>
        <input type="text" id="postTitle" placeholder="Titlul postării">
        <label for="content">Conținut</label>
        <textarea id="postContent" placeholder="Scrie postarea..."></textarea>
        <p id="postMessage" class="message success" style="margin-top: 10px;"></p>
        <div class="row">
            <button type="submit" class="btn btn-primary">Publică</button>
            <button type="button" id="clearBtn" class="btn btn-ghost">Șterge</button>
        </div>
    </form>
</section>

<div id="postsContainer">
    <div class='post-card'>Se încarcă postările...</div>
</div>
</main>
<footer>
&copy; <span id="year"></span> URBLOG
</footer>

<script type="module">
// Firebase modular v9 imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
import {
  getDatabase,
  ref,
  push,
  serverTimestamp,
  query,
  orderByChild,
  onChildAdded,
  onChildChanged,
  onChildRemoved,
  remove,
  set,
  off
} from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

// --- CONFIG: înlocuiește databaseURL din consola ta Firebase dacă e altul ---
const firebaseConfig = {
  apiKey: "AIzaSyDWfXEoPf7Nj9Dgey6f8P3UAyIKMjFUhks",
  authDomain: "urblog-543a4.firebaseapp.com",
  databaseURL: "https://urblog-543a4-default-rtdb.firebaseio.com",
  projectId: "urblog-543a4",
  storageBucket: "urblog-543a4.appspot.com",
  messagingSenderId: "984163939329",
  appId: "1:984163939329:web:be8d66d45f6d1badb4bc00",
  measurementId: "G-7KRZR0X1NG"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// DOM
const postsContainer = document.getElementById('postsContainer');
const postForm = document.getElementById('postForm');
const postTitleInput = document.getElementById('postTitle');
const postContentInput = document.getElementById('postContent');
const authSection = document.getElementById('authSection');
const composerSection = document.getElementById('composer');
const logoutBtn = document.getElementById('logoutBtn');
const headerProfilePic = document.getElementById('headerProfilePic');
const postMessage = document.getElementById('postMessage');
const authMessage = document.getElementById('authMessage');
const authEmail = document.getElementById('authEmail');
const authPassword = document.getElementById('authPassword');
const addPostBtn = document.getElementById('addPostBtn');
const yearSpan = document.getElementById('year');
yearSpan.textContent = new Date().getFullYear();

let currentUser = null;

// Utility
function escapeHtml(str) {
    if (str === null || str === undefined) return "";
    return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;")
                      .replace(/>/g, "&gt;").replace(/\"/g, "&quot;")
                      .replace(/\'/g, "&#39;");
}

function formatDate(ts) {
    if (!ts && ts !== 0) return 'Data necunoscută';
    try {
        // If it's an object with seconds (Firestore-like)
        if (typeof ts === 'object' && ts !== null) {
            if (ts.seconds) return new Date(ts.seconds * 1000).toLocaleString('ro-RO');
            if (ts.hasOwnProperty('toMillis') && typeof ts.toMillis === 'function') {
                return new Date(ts.toMillis()).toLocaleString('ro-RO');
            }
            // If it's a number-like in object (RTDB sometimes)
            if (ts['.sv']) return 'Data server (neprocesată)';
        }
        // if it's numeric timestamp (ms)
        const n = Number(ts);
        if (!isNaN(n)) return new Date(n).toLocaleString('ro-RO');
    } catch (e) {
        // fallthrough
    }
    return 'Data necunoscută';
}

// --- AUTH STATE ---
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        authSection.style.display = 'none';
        composerSection.style.display = 'block';
        logoutBtn.style.display = 'block';
        addPostBtn.style.visibility = 'visible';
        headerProfilePic.textContent = user.email ? user.email.substring(0,2).toUpperCase() : 'U';
        // Load posts (ensure we don't reattach duplicate listeners)
        loadPosts();
    } else {
        currentUser = null;
        authSection.style.display = 'block';
        composerSection.style.display = 'none';
        logoutBtn.style.display = 'none';
        addPostBtn.style.visibility = 'hidden';
        headerProfilePic.textContent = '👤';
        postsContainer.innerHTML = "<div class='post-card'>Te rugăm să te autentifici pentru a vedea postările.</div>";
        // Cleanup listeners
        try {
            const postsRef = ref(db, 'posts');
            off(postsRef);
        } catch (e) { /* ignore */ }
    }
});

// Signup
document.getElementById('signupBtn').addEventListener('click', async () => {
    authMessage.textContent = '';
    try {
        await createUserWithEmailAndPassword(auth, authEmail.value, authPassword.value);
        authMessage.textContent = 'Înregistrare reușită. Ești logat!';
        authMessage.className = 'message success';
    } catch (error) {
        let msg = 'Eroare: ' + (error && error.message ? error.message : 'Necunoscută');
        if (error && error.code) {
            switch (error.code) {
                case 'auth/invalid-email': msg = 'Email invalid.'; break;
                case 'auth/weak-password': msg = 'Parolă prea slabă (minim 6 caractere).'; break;
                case 'auth/email-already-in-use': msg = 'Email-ul este deja folosit.'; break;
            }
        }
        authMessage.textContent = msg;
        authMessage.className = 'message error';
    }
});

// Login
document.getElementById('loginBtn').addEventListener('click', async () => {
    authMessage.textContent = '';
    try {
        await signInWithEmailAndPassword(auth, authEmail.value, authPassword.value);
        authMessage.textContent = 'Autentificare reușită!';
        authMessage.className = 'message success';
    } catch (error) {
        let msg = 'Eroare la autentificare.';
        if (error && error.code) {
            switch (error.code) {
                case 'auth/invalid-email': msg = 'Email invalid.'; break;
                case 'auth/user-not-found': msg = 'Utilizator inexistent.'; break;
                case 'auth/wrong-password': msg = 'Parolă incorectă.'; break;
                default: msg = error.message || msg;
            }
        }
        authMessage.textContent = msg;
        authMessage.className = 'message error';
    }
});

// Logout
logoutBtn.addEventListener('click', async () => {
    try {
        await signOut(auth);
    } catch (e) {
        console.error('Logout error', e);
    }
});

// --- POSTARE NOUĂ ---
postForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    postMessage.textContent = '';
    if (!currentUser) {
        postMessage.textContent = 'Trebuie să fii autentificat pentru a publica.';
        postMessage.className = 'message error';
        return;
    }
    const title = postTitleInput.value.trim();
    const content = postContentInput.value.trim();
    if (title.length < 3 || content.length < 10) {
        postMessage.textContent = "Titlul min. 3, Conținut min. 10 caractere.";
        postMessage.className = 'message error';
        return;
    }
    const submitBtn = postForm.querySelector('button[type=submit]');
    submitBtn.disabled = true; submitBtn.textContent = "Se publică...";
    const newPost = { title, content, authorId: currentUser.uid, authorEmail: currentUser.email, date: serverTimestamp() };
    try {
        await push(ref(db, 'posts'), newPost);
        postForm.reset();
        postMessage.textContent = 'Postare publicată cu succes!';
        postMessage.className = 'message success';
        setTimeout(() => postMessage.textContent = '', 3000);
    } catch (error) {
        postMessage.textContent = `Eroare la publicare: ${error && error.message ? error.message : 'necunoscută'}`;
        postMessage.className = 'message error';
    } finally {
        submitBtn.disabled = false; submitBtn.textContent = "Publică";
    }
});

document.getElementById('clearBtn').addEventListener('click', () => {
    postForm.reset();
    postMessage.textContent = '';
});

// --- LOAD POSTS & COMMENTS ---
let attachedPostListener = false;
function loadPosts() {
    const postsRef = ref(db, 'posts');
    try { off(postsRef); } catch(e) {}
    postsContainer.innerHTML = '';
    const sortedQuery = query(postsRef, orderByChild('date'));
    // Use onChildAdded
    onChildAdded(sortedQuery, (snapshot) => {
        const post = { id: snapshot.key, ...snapshot.val() };
        // create element and prepend
        const postElement = createPostElement(post);
        // Prepend so latest appear on top
        postsContainer.prepend(postElement);
        // load comments for this post
        loadComments(post.id, postElement);
    });
    attachedPostListener = true;
}

function createPostElement(p) {
    const dateStr = formatDate(p.date);
    const initials = p.authorEmail ? p.authorEmail.substring(0,2).toUpperCase() : '??';
    const div = document.createElement('div');
    div.className = 'post-card';
    div.id = `post-${p.id}`;
    // Build innerHTML safely
    div.innerHTML = `
        <div class="post-header">
            <div class="profile-pic">${escapeHtml(initials)}</div>
            <div>
                <div class="username">${escapeHtml(p.title)}</div>
                <div class="time">${escapeHtml(p.authorEmail || 'Anonim')} · ${escapeHtml(dateStr)}</div>
            </div>
        </div>
        <div class="post-content">${escapeHtml(p.content)}</div>
        <div class="post-actions" style="text-align: right;">
            ${currentUser && currentUser.uid === p.authorId ? `<button class="btn btn-ghost delete-post-btn" data-id="${p.id}">🗑️ Șterge</button>` : ''}
        </div>
        <div class="comment-section">
            <div id="comments-container-${p.id}"></div>
            ${currentUser ? `
                <div class="comment-form">
                    <input type="text" id="comment-input-${p.id}" placeholder="Adaugă un comentariu...">
                    <button class="btn btn-primary submit-comment-btn" data-id="${p.id}">Trimite</button>
                </div>` : `<p style="color: var(--muted);">Autentifică-te pentru a comenta.</p>`}
        </div>
    `;
    // Attach delete listener if exists
    const deleteBtn = div.querySelector('.delete-post-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
            const yes = confirm('Ștergi postarea?');
            if (!yes) return;
            const id = deleteBtn.getAttribute('data-id');
            if (!id) return;
            try {
                // Remove post
                await remove(ref(db, 'posts/' + id));
                // Also remove comments for this post
                await remove(ref(db, 'comments/' + id));
                // Remove element from DOM
                const el = document.getElementById(`post-${id}`);
                if (el && el.parentNode) el.parentNode.removeChild(el);
            } catch (e) {
                console.error('Eroare la ștergere', e);
                alert('Eroare la ștergere. Vezi consola.');
            }
        });
    }

    // Attach comment submit if currentUser
    const commentBtn = div.querySelector('.submit-comment-btn');
    if (commentBtn) {
        commentBtn.addEventListener('click', () => submitComment(p.id));
    }

    return div;
}

// Submit comment
async function submitComment(postId) {
    const input = document.getElementById(`comment-input-${postId}`);
    if (!input) return;
    const text = input.value.trim();
    if (!text || text.length < 2) return;
    if (!currentUser) {
        alert('Trebuie să fii autentificat pentru a comenta.');
        return;
    }
    const newComment = {
        text,
        authorEmail: currentUser.email,
        authorId: currentUser.uid,
        date: serverTimestamp()
    };
    try {
        await push(ref(db, `comments/${postId}`), newComment);
        input.value = '';
    } catch (e) {
        console.error('Eroare la adăugare comentariu', e);
        alert('Eroare la trimitere comentariu.');
    }
}

// Load comments for a post element (ensures off() before attach)
function loadComments(postId, postElement) {
    const container = postElement.querySelector(`#comments-container-${postId}`);
    if (!container) return;
    container.innerHTML = '';
    const commentsRef = ref(db, `comments/${postId}`);
    try { off(commentsRef); } catch(e) {}
    const sortedQuery = query(commentsRef, orderByChild('date'));
    onChildAdded(sortedQuery, (snapshot) => {
        const c = { id: snapshot.key, ...snapshot.val() };
        const dateStr = formatDate(c.date);
        const div = document.createElement('div');
        div.className = 'comment-item';
        div.id = `comment-${c.id}`;
        div.innerHTML = `
            <div>
                <span class="comment-author">${escapeHtml(c.authorEmail || 'Anonim')}</span>
                <span class="comment-time">${escapeHtml(dateStr)}</span>
            </div>
            <div class="comment-text" style="margin-top:6px;">${escapeHtml(c.text)}</div>
        `;
        container.appendChild(div);
    });
}

</script>
</body>
</html>



