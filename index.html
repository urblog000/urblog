<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicatie Postări Firestore</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better readability and a clean look */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .post-card { transition: transform 0.2s, box-shadow 0.2s; }
        .post-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app-container" class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-indigo-700 mb-6 border-b pb-2">Platformă de Postări (Real-Time)</h1>
        
        <!-- User Info & Status -->
        <div id="status-message" class="bg-indigo-100 border border-indigo-300 text-indigo-800 px-4 py-3 rounded-lg mb-6">
            Se inițializează...
        </div>

        <!-- Posting Form -->
        <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
            <textarea id="post-content" 
                      placeholder="Ce ai vrea să postezi?" 
                      rows="3"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-3"></textarea>
            <button onclick="postare()" 
                    id="post-button"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg transition duration-150 ease-in-out shadow-md disabled:bg-indigo-400">
                Postează
            </button>
        </div>

        <!-- Posts List -->
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Postări Recente</h2>
        <div id="posts-list" class="space-y-4">
            <!-- Posts will be loaded here -->
            <p class="text-center text-gray-500" id="loading-posts">Se încarcă postările...</p>
        </div>

    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variabile Globale și Inițializare ---
        const statusMessage = document.getElementById('status-message');
        const postsList = document.getElementById('posts-list');
        const postButton = document.getElementById('post-button');
        
        // Asigurarea accesului la variabilele de mediu (MANDATORIU)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Funcția de inițializare și Autentificare
        async function initializeAppAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Configurația Firebase lipsește.");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentificare
                await new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser.uid;
                        }
                        isAuthReady = true;
                        statusMessage.className = 'bg-green-100 border border-green-300 text-green-800 px-4 py-3 rounded-lg mb-6';
                        statusMessage.innerHTML = `Autentificare reușită! ID Utilizator: <span class="font-mono text-sm">${userId}</span>`;
                        resolve();
                    });
                });
            } catch (error) {
                console.error("Eroare la inițializarea Firebase sau autentificare:", error);
                statusMessage.className = 'bg-red-100 border border-red-300 text-red-800 px-4 py-3 rounded-lg mb-6';
                statusMessage.textContent = `EROARE: Nu s-a putut inițializa aplicația. Vezi consola pentru detalii.`;
            }
        }

        // --- Functia de Postare ---
        window.postare = async function() {
            if (!isAuthReady || !db || !userId) {
                statusMessage.textContent = "Așteaptă finalizarea autentificării înainte de a posta.";
                return;
            }

            const contentInput = document.getElementById('post-content');
            const content = contentInput.value.trim();

            if (content.length === 0) {
                alertUser("Te rog introdu un conținut pentru postare.");
                return;
            }

            postButton.disabled = true;
            postButton.textContent = 'Se postează...';

            try {
                // Calea colecției pentru date Publice
                const collectionPath = `artifacts/${appId}/public/data/posts`;
                
                // Adaugă documentul în Firestore
                await addDoc(collection(db, collectionPath), {
                    content: content,
                    userId: userId,
                    timestamp: Date.now() 
                });

                contentInput.value = ''; // Golește câmpul după postare reușită
                alertUser("Postare trimisă cu succes!", 'success');

            } catch (error) {
                console.error("Eroare la adăugarea documentului:", error);
                alertUser(`Eroare la postare: ${error.message}`, 'error');
            } finally {
                postButton.disabled = false;
                postButton.textContent = 'Postează';
            }
        }
        
        // --- Funcția de Ascultare și Afișare a Postărilor în Timp Real ---
        function listenForPosts() {
            if (!isAuthReady || !db) return;

            // Calea colecției (aceeași ca la postare)
            const collectionPath = `artifacts/${appId}/public/data/posts`;
            const q = query(collection(db, collectionPath));
            
            // onSnapshot asigură sincronizarea în timp real
            onSnapshot(q, (snapshot) => {
                const posts = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    posts.push({ id: doc.id, ...data });
                });

                // Sortează postările după timestamp (cel mai nou primul)
                posts.sort((a, b) => b.timestamp - a.timestamp);

                renderPosts(posts);
            }, (error) => {
                console.error("Eroare la ascultarea postărilor:", error);
                postsList.innerHTML = `<p class="text-center text-red-500">Eroare la încărcarea postărilor: ${error.message}</p>`;
            });
        }

        // --- Funcția de Randare a Postărilor în UI ---
        function renderPosts(posts) {
            postsList.innerHTML = ''; // Golește lista existentă
            document.getElementById('loading-posts')?.remove(); // Elimină mesajul de încărcare

            if (posts.length === 0) {
                postsList.innerHTML = `<p class="text-center text-gray-500">Nu există postări încă. Fii primul!</p>`;
                return;
            }

            posts.forEach(post => {
                const isMine = post.userId === userId;
                
                const postElement = document.createElement('div');
                postElement.className = 'post-card p-4 border border-gray-200 rounded-xl shadow-lg bg-white transition duration-150';
                
                const date = post.timestamp ? new Date(post.timestamp).toLocaleTimeString('ro-RO', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Necunoscută';

                postElement.innerHTML = `
                    <p class="text-gray-800 whitespace-pre-wrap mb-3">${post.content}</p>
                    <div class="border-t pt-2 mt-2 flex justify-between items-center text-xs text-gray-500">
                        <span class="font-medium ${isMine ? 'text-indigo-600' : 'text-gray-600'}">
                            Postat de: ${isMine ? 'Mine' : post.userId.substring(0, 8) + '...'}
                        </span>
                        <span>
                            ${date}
                        </span>
                    </div>
                `;
                postsList.appendChild(postElement);
            });
        }

        // --- Funcție ajutătoare pentru alertă non-blocking ---
        function alertUser(message, type = 'info') {
            let container = document.getElementById('alert-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'alert-container';
                container.className = 'fixed top-4 right-4 z-50 space-y-2';
                document.body.appendChild(container);
            }

            const alertDiv = document.createElement('div');
            let colorClass;
            
            if (type === 'success') {
                colorClass = 'bg-green-500';
            } else if (type === 'error') {
                colorClass = 'bg-red-500';
            } else {
                colorClass = 'bg-blue-500';
            }

            alertDiv.className = `${colorClass} text-white px-6 py-3 rounded-lg shadow-xl opacity-0 transform translate-x-full transition-all duration-300`;
            alertDiv.textContent = message;
            container.appendChild(alertDiv);

            // Animație de intrare
            setTimeout(() => {
                alertDiv.classList.remove('opacity-0', 'translate-x-full');
            }, 10);

            // Animație de ieșire și ștergere
            setTimeout(() => {
                alertDiv.classList.add('opacity-0', 'translate-x-full');
                alertDiv.addEventListener('transitionend', () => alertDiv.remove());
            }, 4000);
        }

        // --- Start Application ---
        initializeAppAndAuth().then(() => {
            if (db && userId) {
                listenForPosts();
            }
        });

    </script>
</body>
</html>

